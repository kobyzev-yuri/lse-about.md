# Анализ времени обновления цен в cron

## Текущая конфигурация

В `setup_cron.sh` указано:
```bash
0 18 * * * cd $PROJECT_DIR && $PYTHON_PATH scripts/update_prices_cron.py
```

**Важно:** Cron использует **системный часовой пояс сервера**, не обязательно московский!

---

## Часы работы бирж

### LSE (London Stock Exchange)
- **Открытие**: 08:00 GMT (11:00 MSK зимой, 12:00 MSK летом)
- **Закрытие**: 16:30 GMT (19:30 MSK зимой, 20:30 MSK летом)

### NYSE/NASDAQ (для MSFT, SNDK)
- **Открытие**: 09:30 EST (17:30 MSK зимой, 18:30 MSK летом)
- **Закрытие**: 16:00 EST (00:00 MSK зимой, 01:00 MSK летом)

### Forex (GBPUSD=X)
- **Круглосуточная торговля** (кроме выходных)
- **Лондонская сессия**: 10:00-19:00 MSK (активная)
- **Нью-Йоркская сессия**: 16:00-01:00 MSK (активная)

---

## Анализ времени 18:00 MSK

### Зимнее время (MSK = UTC+3)
- 18:00 MSK = 15:00 GMT = 10:00 EST
- ✅ LSE еще открыта (закроется в 19:30 MSK)
- ❌ NYSE еще не открыта (откроется в 17:30 MSK)
- ✅ Forex активна (лондонская сессия)

### Летнее время (MSK = UTC+3, но может быть UTC+2)
- 18:00 MSK = 15:00 GMT = 10:00 EST
- ✅ LSE еще открыта (закроется в 20:30 MSK)
- ❌ NYSE еще не открыта (откроется в 18:30 MSK)
- ✅ Forex активна (лондонская сессия)

---

## Проблема

**18:00 MSK - это слишком рано для NYSE!**

- NYSE открывается в 17:30 MSK (зимой) или 18:30 MSK (летом)
- В 18:00 MSK NYSE либо еще не открыта, либо только что открылась
- Данные за день еще не сформированы

---

## Рекомендуемое время обновления

### Вариант 1: После закрытия всех бирж (универсальный)
**22:00 MSK** (или 23:00 MSK для надежности)
- ✅ LSE закрыта (19:30 MSK)
- ✅ NYSE закрыта (00:00 MSK зимой, 01:00 MSK летом)
- ✅ Данные за день полностью сформированы
- ✅ Forex активна, но дневные данные доступны

### Вариант 2: После закрытия LSE (для LSE-ориентированной торговли)
**20:00 MSK** (или 21:00 MSK)
- ✅ LSE закрыта (19:30 MSK)
- ⚠️ NYSE еще открыта (закроется в 00:00 MSK)
- ⚠️ Данные по MSFT/SNDK могут быть неполными

### Вариант 3: Утром следующего дня (самый надежный)
**09:00 MSK** (или 10:00 MSK)
- ✅ Все биржи закрыты
- ✅ Данные за предыдущий день полностью доступны
- ✅ Можно использовать для торговли в течение дня

---

## Рекомендация для песочницы

**Использовать 22:00 MSK** (или 23:00 MSK для надежности):

```bash
# В setup_cron.sh изменить:
0 22 * * * cd $PROJECT_DIR && $PYTHON_PATH scripts/update_prices_cron.py
```

**Обоснование:**
- ✅ Все биржи закрыты
- ✅ Данные за день полностью сформированы
- ✅ Можно использовать для анализа на следующий день
- ✅ Торговый цикл в 9:00, 13:00, 17:00 будет использовать актуальные данные

---

## Важно: Проверка часового пояса сервера

Cron использует системный часовой пояс сервера. Если сервер не в MSK:

```bash
# Проверить часовой пояс
timedatectl | grep "Time zone"
# или
date
# или
cat /etc/timezone
```

**Если сервер в UTC:**
- 18:00 MSK = 15:00 UTC
- Нужно указать в cron: `0 15 * * *` (для 18:00 MSK)

**Если сервер в MSK:**
- Можно использовать: `0 22 * * *` (для 22:00 MSK)

---

## Альтернатива: Явное указание часового пояса

Можно модифицировать cron скрипт для явного указания часового пояса:

```bash
# В setup_cron.sh:
TZ=Europe/Moscow
0 22 * * * cd $PROJECT_DIR && $PYTHON_PATH scripts/update_prices_cron.py
```

Или в самом скрипте Python:

```python
import os
os.environ['TZ'] = 'Europe/Moscow'
```

---

## Итоговая рекомендация

1. **Изменить время обновления на 22:00 MSK** (или 23:00 MSK)
2. **Проверить часовой пояс сервера** перед установкой cron
3. **При необходимости явно указать часовой пояс** в cron или скрипте

---

## См. также

- [setup_cron.sh](../setup_cron.sh) - скрипт установки cron
- [scripts/update_prices_cron.py](../scripts/update_prices_cron.py) - скрипт обновления цен
- [Market Hours Guide](https://www.investopedia.com/articles/trading/05/021805.asp) - часы работы бирж

