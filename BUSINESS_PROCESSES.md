# –ë–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å—ã –∏ –ø–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö LSE Trading System

–î–∞–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å—ã –∏ –ø–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ç–æ—Ä–≥–æ–≤–ª–∏ –Ω–∞ –õ–æ–Ω–¥–æ–Ω—Å–∫–æ–π —Ñ–æ–Ω–¥–æ–≤–æ–π –±–∏—Ä–∂–µ –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –Ω–æ—Ç–∞—Ü–∏–∏ [Mermaid](https://mermaid.js.org/), –∫–æ—Ç–æ—Ä–∞—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ Markdown –∏ GitHub.

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö](#1-–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è-—Å–∏—Å—Ç–µ–º—ã-–∏-–∑–∞–≥—Ä—É–∑–∫–∞-–¥–∞–Ω–Ω—ã—Ö)
2. [–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω –∫–æ—Ç–∏—Ä–æ–≤–æ–∫](#2-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ-—Ü–µ–Ω-–∫–æ—Ç–∏—Ä–æ–≤–æ–∫)
3. [–ò–º–ø–æ—Ä—Ç –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π](#3-–∏–º–ø–æ—Ä—Ç-–∏-–æ–±—Ä–∞–±–æ—Ç–∫–∞-–Ω–æ–≤–æ—Å—Ç–µ–π)
4. [–ê–Ω–∞–ª–∏–∑ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤](#4-–∞–Ω–∞–ª–∏–∑-—Ç–æ—Ä–≥–æ–≤—ã—Ö-—Å–∏–≥–Ω–∞–ª–æ–≤)
5. [–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–¥–µ–ª–æ–∫](#5-–∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ-—Å–¥–µ–ª–æ–∫)
6. [–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∏—Å–∫–∞–º–∏ (—Å—Ç–æ–ø-–ª–æ—Å—Å—ã)](#6-—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ-—Ä–∏—Å–∫–∞–º–∏-—Å—Ç–æ–ø-–ª–æ—Å—Å—ã)
7. [–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤](#7-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è-–æ—Ç—á–µ—Ç–æ–≤)
8. [–í–µ–∫—Ç–æ—Ä–Ω–∞—è –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π](#8-–≤–µ–∫—Ç–æ—Ä–Ω–∞—è-–±–∞–∑–∞-–∑–Ω–∞–Ω–∏–π)
9. [–î–∏–∞–≥—Ä–∞–º–º—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤](#9-–¥–∏–∞–≥—Ä–∞–º–º—ã-–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤)

---

## 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö

### 1.1. –ü—Ä–æ—Ü–µ—Å—Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```mermaid
flowchart TD
    A[–ó–∞–ø—É—Å–∫ init_db.py] --> B[–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ config.env]
    B --> C[–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL]
    C --> D{–ë–∞–∑–∞ lse_trading —Å—É—â–µ—Å—Ç–≤—É–µ—Ç?}
    D -->|–ù–µ—Ç| E[–°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö]
    D -->|–î–∞| F[–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π]
    E --> F
    F --> G{–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ pgvector —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ?}
    G -->|–ù–µ—Ç| H[CREATE EXTENSION vector]
    G -->|–î–∞| I[–°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü]
    H --> I
    
    I --> J[quotes: –∫–æ—Ç–∏—Ä–æ–≤–∫–∏ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏]
    I --> K[trade_kb: –≤–µ–∫—Ç–æ—Ä–Ω–∞—è –ë–ó]
    I --> L[knowledge_base: –Ω–æ–≤–æ—Å—Ç–∏ —Å sentiment]
    I --> M[portfolio_state: —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Ä—Ç—Ñ–µ–ª—è]
    I --> N[trade_history: –∏—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫]
    
    J --> O[–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ –∫–∞–ø–∏—Ç–∞–ª–∞]
    K --> O
    L --> O
    M --> O
    N --> O
    
    O --> P[–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ yfinance]
    P --> Q[–†–∞—Å—á–µ—Ç SMA_5 –∏ volatility_5]
    Q --> R[–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ quotes]
    R --> S[‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ]
    
    style A fill:#e1f5ff
    style S fill:#c8e6c9
    style I fill:#fff9c4
```

**–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π**: –ü—Ä–æ—Ü–µ—Å—Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –Ω–∞—á–∞–ª—å–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ `pgvector` –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤–µ–∫—Ç–æ—Ä–Ω—ã–º–∏ embeddings –≤ –±—É–¥—É—â–µ–º. –°—Ç–∞—Ä—Ç–æ–≤—ã–π –∫–∞–ø–∏—Ç–∞–ª —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ 100,000 USD.

### 1.2. –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö

```mermaid
sequenceDiagram
    participant Script as init_db.py
    participant YFinance as yfinance API
    participant Pandas as pandas
    participant DB as PostgreSQL
    
    Script->>YFinance: –ó–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö (period="2y", interval="1d")
    YFinance-->>Script: DataFrame —Å –∫–æ—Ç–∏—Ä–æ–≤–∫–∞–º–∏
    
    Script->>Pandas: –†–∞—Å—á–µ—Ç SMA_5 –∏ volatility_5
    Pandas-->>Script: DataFrame —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏
    
    Script->>DB: INSERT INTO quotes (date, ticker, close, volume, sma_5, volatility_5)
    DB-->>Script: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—Å—Ç–∞–≤–∫–∏
    
    Note over Script,DB: –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–∫–µ—Ä–∞: MSFT, SNDK, GBPUSD=X
```

**–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ `yfinance` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö. –ú–µ—Ç—Ä–∏–∫–∏ SMA (Simple Moving Average) –∏ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ pandas –∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å –∫–æ—Ç–∏—Ä–æ–≤–∫–∞–º–∏ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.

---

## 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω –∫–æ—Ç–∏—Ä–æ–≤–æ–∫

### 2.1. –ü—Ä–æ—Ü–µ—Å—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–µ–Ω

```mermaid
flowchart TD
    A[–ó–∞–ø—É—Å–∫ update_prices.py] --> B[–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö —Ç–∏–∫–µ—Ä–æ–≤]
    B --> C{–¢–∏–∫–µ—Ä—ã —É–∫–∞–∑–∞–Ω—ã –≤ –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ö?}
    C -->|–î–∞| D[–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É–∫–∞–∑–∞–Ω–Ω—ã–µ —Ç–∏–∫–µ—Ä—ã]
    C -->|–ù–µ—Ç| E[–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ —Ç–∏–∫–µ—Ä—ã –∏–∑ quotes]
    D --> F[–î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–∫–µ—Ä–∞]
    E --> F
    
    F --> G[–ü–æ–ª—É—á–∏—Ç—å –¥–∞—Ç—É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è]
    G --> H{–î–∞–Ω–Ω—ã–µ –µ—Å—Ç—å –≤ –ë–î?}
    H -->|–î–∞| I[–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –¥–∞—Ç—ã + 1 –¥–µ–Ω—å]
    H -->|–ù–µ—Ç| J[–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π]
    
    I --> K[yfinance.download]
    J --> K
    K --> L{–î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã?}
    L -->|–ù–µ—Ç| M[‚ö†Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ç–∏–∫–µ—Ä]
    L -->|–î–∞| N[–†–∞—Å—á–µ—Ç SMA_5 –∏ volatility_5]
    
    N --> O[–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö]
    O --> P{–ï—Å—Ç—å –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ?}
    P -->|–ù–µ—Ç| Q[‚úÖ –î–∞–Ω–Ω—ã–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã]
    P -->|–î–∞| R[–í—Å—Ç–∞–≤–∫–∞ –≤ quotes —Å ON CONFLICT DO NOTHING]
    
    R --> S[‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ N –∑–∞–ø–∏—Å–µ–π]
    M --> T[–°–ª–µ–¥—É—é—â–∏–π —Ç–∏–∫–µ—Ä]
    Q --> T
    S --> T
    T --> U{–ï—Å—Ç—å –µ—â–µ —Ç–∏–∫–µ—Ä—ã?}
    U -->|–î–∞| F
    U -->|–ù–µ—Ç| V[‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ]
    
    style A fill:#e1f5ff
    style V fill:#c8e6c9
    style K fill:#fff9c4
```

**–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π**: –ü—Ä–æ—Ü–µ—Å—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–µ–Ω –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é –∏–ª–∏ —á–µ—Ä–µ–∑ cron –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è. –°–∫—Ä–∏–ø—Ç —É–º–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –Ω—É–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å–∏. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `ON CONFLICT DO NOTHING` –¥–ª—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏.

### 2.2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ cron

```mermaid
flowchart LR
    A[Cron: –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 18:00] --> B[–ó–∞–ø—É—Å–∫ update_prices.py]
    B --> C[–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Ç–∏–∫–µ—Ä–æ–≤]
    C --> D[–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤]
    D --> E{–û—à–∏–±–∫–∏?}
    E -->|–î–∞| F[–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è]
    E -->|–ù–µ—Ç| G[‚úÖ –£—Å–ø–µ—à–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ]
    
    style A fill:#e1f5ff
    style G fill:#c8e6c9
```

**–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π**: –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å cron –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–µ–Ω –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è —Ç–æ—Ä–≥–æ–≤–æ–π —Å–µ—Å—Å–∏–∏. –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ç–æ—Ä–≥–æ–≤–æ–≥–æ –¥–Ω—è.

---

## 3. –ò–º–ø–æ—Ä—Ç –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π

### 3.1. –ü—Ä–æ—Ü–µ—Å—Å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ—Å—Ç–µ–π

```mermaid
flowchart TD
    A[–ò—Å—Ç–æ—á–Ω–∏–∫ –Ω–æ–≤–æ—Å—Ç–∏] --> B{–¢–∏–ø –∏—Å—Ç–æ—á–Ω–∏–∫–∞}
    B -->|–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –≤–≤–æ–¥| C[news_importer.py add]
    B -->|CSV —Ñ–∞–π–ª| D[news_importer.py import file.csv]
    B -->|JSON —Ñ–∞–π–ª| E[news_importer.py import file.json]
    B -->|API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è| F[–ë—É–¥—É—â–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è]
    
    C --> G[–í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ CLI]
    D --> H[–ü–∞—Ä—Å–∏–Ω–≥ CSV]
    E --> I[–ü–∞—Ä—Å–∏–Ω–≥ JSON]
    
    G --> J[–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö]
    H --> J
    I --> J
    
    J --> K{–î–∞–Ω–Ω—ã–µ –≤–∞–ª–∏–¥–Ω—ã?}
    K -->|–ù–µ—Ç| L[‚ùå –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏]
    K -->|–î–∞| M[–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–∫–µ—Ä–∞]
    
    M --> N{–¢–∏–ø —Ç–∏–∫–µ—Ä–∞}
    N -->|–û–±—ã—á–Ω—ã–π —Ç–∏–∫–µ—Ä| O[MSFT, SNDK –∏ —Ç.–¥.]
    N -->|–ú–∞–∫—Ä–æ-—Å–æ–±—ã—Ç–∏–µ| P[MACRO –∏–ª–∏ US_MACRO]
    
    O --> Q[INSERT INTO knowledge_base]
    P --> Q
    
    Q --> R[–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: ticker, source, content, sentiment_score, ts]
    R --> S[‚úÖ –ù–æ–≤–æ—Å—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∞]
    
    style A fill:#e1f5ff
    style S fill:#c8e6c9
    style Q fill:#fff9c4
```

**–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π**: –ù–æ–≤–æ—Å—Ç–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü—É `knowledge_base` —Å sentiment score. –ú–∞–∫—Ä–æ-—Å–æ–±—ã—Ç–∏—è (MACRO, US_MACRO) –∏–º–µ—é—Ç –±–æ–ª—å—à–∏–π –≤—Ä–µ–º–µ–Ω–Ω–æ–π –ª–∞–≥ –≤–ª–∏—è–Ω–∏—è (72 —á–∞—Å–∞) –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –æ–±—ã—á–Ω—ã–º–∏ –Ω–æ–≤–æ—Å—Ç—è–º–∏ (24 —á–∞—Å–∞). Sentiment score –º–æ–∂–µ—Ç –±—ã—Ç—å —É–∫–∞–∑–∞–Ω –≤—Ä—É—á–Ω—É—é –∏–ª–∏ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ –±—É–¥—É—â–µ–º.

### 3.2. –í—Ä–µ–º–µ–Ω–Ω–æ–π –ª–∞–≥ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –Ω–æ–≤–æ—Å—Ç–µ–π

```mermaid
stateDiagram-v2
    [*] --> –ù–æ–≤–æ—Å—Ç—å_–ø–æ—Å—Ç—É–ø–∏–ª–∞: –ù–æ–≤–æ—Å—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∞
    –ù–æ–≤–æ—Å—Ç—å_–ø–æ—Å—Ç—É–ø–∏–ª–∞ --> –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ_—Ç–∏–ø–∞: –ê–Ω–∞–ª–∏–∑ —Ç–∏–∫–µ—Ä–∞
    
    –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ_—Ç–∏–ø–∞ --> –ú–∞–∫—Ä–æ_–Ω–æ–≤–æ—Å—Ç—å: ticker = MACRO/US_MACRO
    –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ_—Ç–∏–ø–∞ --> –û–±—ã—á–Ω–∞—è_–Ω–æ–≤–æ—Å—Ç—å: ticker = –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–∏–∫–µ—Ä
    
    –ú–∞–∫—Ä–æ_–Ω–æ–≤–æ—Å—Ç—å --> –ê–∫—Ç–∏–≤–Ω–∞_72—á: –í–ª–∏—è–Ω–∏–µ 72 —á–∞—Å–∞
    –û–±—ã—á–Ω–∞—è_–Ω–æ–≤–æ—Å—Ç—å --> –ê–∫—Ç–∏–≤–Ω–∞_24—á: –í–ª–∏—è–Ω–∏–µ 24 —á–∞—Å–∞
    
    –ê–∫—Ç–∏–≤–Ω–∞_72—á --> –£—Å—Ç–∞—Ä–µ–ª–∞: –ü—Ä–æ—à–ª–æ 72 —á–∞—Å–∞
    –ê–∫—Ç–∏–≤–Ω–∞_24—á --> –£—Å—Ç–∞—Ä–µ–ª–∞: –ü—Ä–æ—à–ª–æ 24 —á–∞—Å–∞
    
    –£—Å—Ç–∞—Ä–µ–ª–∞ --> [*]: –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∞–Ω–∞–ª–∏–∑–µ
```

**–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π**: –ú–∞–∫—Ä–æ-—Å–æ–±—ã—Ç–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–∞–Ω–Ω—ã–µ –ø–æ –∏–Ω—Ñ–ª—è—Ü–∏–∏, –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–º —Å—Ç–∞–≤–∫–∞–º) –∏–º–µ—é—Ç –±–æ–ª–µ–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ –Ω–∞ —Ä—ã–Ω–æ–∫, –ø–æ—ç—Ç–æ–º—É —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ 72 —á–∞—Å–æ–≤. –ù–æ–≤–æ—Å—Ç–∏ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∫–æ–º–ø–∞–Ω–∏—è–º –æ–±—ã—á–Ω–æ –≤–ª–∏—è—é—Ç –±—ã—Å—Ç—Ä–µ–µ, –ø–æ—ç—Ç–æ–º—É –≤—Ä–µ–º–µ–Ω–Ω–æ–π –ª–∞–≥ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç 24 —á–∞—Å–∞.

---

## 4. –ê–Ω–∞–ª–∏–∑ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤

### 4.1. –ü—Ä–æ—Ü–µ—Å—Å –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏—è AnalystAgent

```mermaid
flowchart TD
    A[AnalystAgent.get_decision] --> B[–®–ê–ì 1: –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑]
    B --> C[–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 5 –¥–Ω–µ–π –∫–æ—Ç–∏—Ä–æ–≤–æ–∫]
    C --> D[–†–∞—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–µ–π –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ –∑–∞ 20 –¥–Ω–µ–π]
    D --> E{–£—Å–ª–æ–≤–∏—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞}
    
    E -->|close > sma_5 AND volatility_5 < avg_vol_20| F[–°–∏–≥–Ω–∞–ª: BUY]
    E -->|–ò–Ω–∞—á–µ| G[–°–∏–≥–Ω–∞–ª: HOLD]
    
    F --> H[–®–ê–ì 2: –ê–Ω–∞–ª–∏–∑ –Ω–æ–≤–æ—Å—Ç–µ–π]
    G --> H
    
    H --> I[–ü–æ–∏—Å–∫ –Ω–æ–≤–æ—Å—Ç–µ–π –∑–∞ –ø–µ—Ä–∏–æ–¥]
    I --> J{–¢–∏–ø –Ω–æ–≤–æ—Å—Ç–µ–π}
    J -->|–ú–∞–∫—Ä–æ-—Å–æ–±—ã—Ç–∏—è| K[–ü–µ—Ä–∏–æ–¥: 72 —á–∞—Å–∞]
    J -->|–û–±—ã—á–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏| L[–ü–µ—Ä–∏–æ–¥: 24 —á–∞—Å–∞]
    
    K --> M[–†–∞—Å—á–µ—Ç –≤–∑–≤–µ—à–µ–Ω–Ω–æ–≥–æ sentiment]
    L --> M
    
    M --> N{–ù–æ–≤–æ—Å—Ç–∏ –Ω–∞–π–¥–µ–Ω—ã?}
    N -->|–î–∞| O[–í–∑–≤–µ—à–∏–≤–∞–Ω–∏–µ: –Ω–æ–≤–æ—Å—Ç–∏ —Å —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ–º —Ç–∏–∫–µ—Ä–∞ = 2.0, –º–∞–∫—Ä–æ = 1.0]
    N -->|–ù–µ—Ç| P[Sentiment = 0.0]
    
    O --> Q[–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è sentiment: 0.0-1.0 -> -1.0 –¥–æ 1.0]
    P --> Q
    
    Q --> R[–®–ê–ì 3: –í—ã–±–æ—Ä —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —á–µ—Ä–µ–∑ Strategy Manager]
    
    R --> S{–ê–Ω–∞–ª–∏–∑ —Ä–µ–∂–∏–º–∞ —Ä—ã–Ω–∫–∞}
    S -->|–í—ã—Å–æ–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å + –≥—ç–ø/sentiment| T[VolatileGapStrategy]
    S -->|–ù–∏–∑–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å + –ø–æ–∑–∏—Ç–∏–≤| U[MomentumStrategy]
    S -->|–í—ã—Å–æ–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å + –Ω–µ–π—Ç—Ä–∞–ª| V[MeanReversionStrategy]
    S -->|–ù–µ –ø–æ–¥—Ö–æ–¥–∏—Ç| W[Fallback: –±–∞–∑–æ–≤–∞—è –ª–æ–≥–∏–∫–∞]
    
    T --> X[–†–∞—Å—á–µ—Ç —Å–∏–≥–Ω–∞–ª–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏]
    U --> X
    V --> X
    W --> X
    
    X --> Y[–®–ê–ì 4: LLM –∞–Ω–∞–ª–∏–∑ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ]
    Y --> Z{LLM –¥–æ—Å—Ç—É–ø–µ–Ω?}
    Z -->|–î–∞| AA[LLM guidance –∏ –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑]
    Z -->|–ù–µ—Ç| AB[–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏]
    
    AA --> AC{–§–∏–Ω–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ}
    AB --> AC
    
    AC -->|BUY + –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π sentiment| AD[STRONG_BUY]
    AC -->|BUY + –ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π sentiment| AE[BUY]
    AC -->|HOLD| AF[HOLD]
    
    AD --> AG[‚úÖ –†–µ—à–µ–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ]
    AE --> AG
    AF --> AG
    
    style A fill:#e1f5ff
    style Y fill:#c8e6c9
    style M fill:#fff9c4
```

**–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π**: –ü—Ä–æ—Ü–µ—Å—Å –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏—è –∫–æ–º–±–∏–Ω–∏—Ä—É–µ—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ (—Ç—Ä–µ–Ω–¥ –∏ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å) —Å –∞–Ω–∞–ª–∏–∑–æ–º –Ω–æ–≤–æ—Å—Ç–µ–π (sentiment). –í–∑–≤–µ—à–µ–Ω–Ω—ã–π sentiment –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç—Å—è –≤ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é —à–∫–∞–ª—É (-1.0 –¥–æ 1.0) –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π. Strategy Manager –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∂–∏–º–∞ —Ä—ã–Ω–∫–∞ (–≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å, sentiment, –≥—ç–ø—ã). LLM –∞–Ω–∞–ª–∏–∑ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.

### 4.2. –†–∞—Å—á–µ—Ç –≤–∑–≤–µ—à–µ–Ω–Ω–æ–≥–æ sentiment

```mermaid
flowchart LR
    A[–ù–æ–≤–æ—Å—Ç–∏ –¥–ª—è —Ç–∏–∫–µ—Ä–∞] --> B{–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥–æ–π –Ω–æ–≤–æ—Å—Ç–∏}
    B --> C{–¢–∏–∫–µ—Ä —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–Ω—Ç–µ?}
    C -->|–î–∞| D[Weight = 2.0]
    C -->|–ù–µ—Ç| E[Weight = 1.0]
    
    D --> F[–í–∑–≤–µ—à–µ–Ω–Ω–∞—è —Å—É–º–º–∞]
    E --> F
    F --> G[weighted_sum = —Å—É–º–º–∞ sentiment —É–º–Ω–æ–∂–∏—Ç—å weight]
    F --> H[total_weight = —Å—É–º–º–∞ weight]
    
    G --> I[weighted_sentiment = weighted_sum —Ä–∞–∑–¥–µ–ª–∏—Ç—å total_weight]
    H --> I
    I --> J[‚úÖ –í–∑–≤–µ—à–µ–Ω–Ω—ã–π sentiment]
    
    style A fill:#e1f5ff
    style J fill:#c8e6c9
    style I fill:#fff9c4
```

**–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π**: –í–∑–≤–µ—à–∏–≤–∞–Ω–∏–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç —É—á–∏—Ç—ã–≤–∞—Ç—å, —á—Ç–æ –Ω–æ–≤–æ—Å—Ç–∏, –Ω–∞–ø—Ä—è–º—É—é —É–ø–æ–º–∏–Ω–∞—é—â–∏–µ —Ç–∏–∫–µ—Ä, –±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã, —á–µ–º –æ–±—â–∏–µ –º–∞–∫—Ä–æ-–Ω–æ–≤–æ—Å—Ç–∏. –≠—Ç–æ —É–ª—É—á—à–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ sentiment –∞–Ω–∞–ª–∏–∑–∞.

---

## 5. –ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–¥–µ–ª–æ–∫

### 5.1. –ü—Ä–æ—Ü–µ—Å—Å –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è —Å–¥–µ–ª–æ–∫ ExecutionAgent

```mermaid
flowchart TD
    A[ExecutionAgent.run_for_tickers] --> B[–î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–∫–µ—Ä–∞]
    B --> C[–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–∞ –æ—Ç AnalystAgent]
    C --> D{–¢–∏–ø —Å–∏–≥–Ω–∞–ª–∞}
    
    D -->|BUY –∏–ª–∏ STRONG_BUY| E{–ü–æ–∑–∏—Ü–∏—è —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–∞?}
    D -->|HOLD| F[–ü—Ä–æ–ø—É—Å–∫ –ø–æ–∫—É–ø–∫–∏]
    
    E -->|–î–∞| G[–ü—Ä–æ–ø—É—Å–∫: –ø–æ–∑–∏—Ü–∏—è —É–∂–µ –µ—Å—Ç—å]
    E -->|–ù–µ—Ç| H[–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –∫—ç—à–∞]
    
    H --> I{–ö—ç—à –¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω?}
    I -->|–ù–µ—Ç| J[‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤]
    I -->|–î–∞| K[–†–∞—Å—á–µ—Ç —Ä–∞–∑–º–µ—Ä–∞ –ø–æ–∑–∏—Ü–∏–∏: 10% –æ—Ç –∫—ç—à–∞]
    
    K --> L[–†–∞—Å—á–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞: floor allocation —Ä–∞–∑–¥–µ–ª–∏—Ç—å price]
    L --> M[–†–∞—Å—á–µ—Ç –∫–æ–º–∏—Å—Å–∏–∏: notional —É–º–Ω–æ–∂–∏—Ç—å 0.1 –ø—Ä–æ—Ü–µ–Ω—Ç–∞]
    M --> N[–ü—Ä–æ–≤–µ—Ä–∫–∞: total_cost <= cash]
    
    N -->|–ù–µ—Ç| O[‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ —Å —É—á–µ—Ç–æ–º –∫–æ–º–∏—Å—Å–∏–∏]
    N -->|–î–∞| P[–ü–æ–ª—É—á–µ–Ω–∏–µ sentiment –¥–ª—è –∑–∞–ø–∏—Å–∏]
    
    P --> Q[–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞: cash - total_cost]
    Q --> R[–î–æ–±–∞–≤–ª–µ–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –≤ portfolio_state]
    R --> S[–ó–∞–ø–∏—Å—å —Å–¥–µ–ª–∫–∏ –≤ trade_history]
    
    S --> T[‚úÖ –ü–æ–∫—É–ø–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞]
    F --> U[–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ø-–ª–æ—Å—Å–æ–≤]
    G --> U
    J --> U
    O --> U
    T --> U
    
    U --> V{–ï—Å—Ç—å –µ—â–µ —Ç–∏–∫–µ—Ä—ã?}
    V -->|–î–∞| B
    V -->|–ù–µ—Ç| W[‚úÖ –ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ]
    
    style A fill:#e1f5ff
    style W fill:#c8e6c9
    style S fill:#fff9c4
```

**–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π**: ExecutionAgent –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥: —Ä–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω 10% –æ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –∫—ç—à–∞, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥–∏–≤–µ—Ä—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ä—Ç—Ñ–µ–ª—å. –ö–æ–º–∏—Å—Å–∏—è —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Å–¥–µ–ª–∫–∏ (0.1% –æ—Ç –Ω–æ–º–∏–Ω–∞–ª–∞). –í—Å–µ —Å–¥–µ–ª–∫–∏ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ `trade_history` —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º sentiment –Ω–∞ –º–æ–º–µ–Ω—Ç —Å–¥–µ–ª–∫–∏ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.

### 5.2. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏—è–º–∏

```mermaid
sequenceDiagram
    participant EA as ExecutionAgent
    participant DB as PostgreSQL
    participant Portfolio as portfolio_state
    
    EA->>DB: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π
    DB-->>EA: –°–ø–∏—Å–æ–∫ –ø–æ–∑–∏—Ü–∏–π (ticker, quantity, avg_entry_price)
    
    EA->>EA: –†–∞—Å—á–µ—Ç —Ç–µ–∫—É—â–µ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–æ–∑–∏—Ü–∏–π
    EA->>EA: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ –¥–∏–≤–µ—Ä—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
    
    Note over EA,Portfolio: –ü—Ä–∏ –ø–æ–∫—É–ø–∫–µ: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ avg_entry_price —á–µ—Ä–µ–∑ —Å—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω—É—é —Ñ–æ—Ä–º—É–ª—É
    EA->>Portfolio: INSERT/UPDATE –ø–æ–∑–∏—Ü–∏–∏
    Portfolio-->>EA: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    
    Note over EA,Portfolio: avg_entry_price = old_qty —É–º–Ω–æ–∂–∏—Ç—å old_price –ø–ª—é—Å new_qty —É–º–Ω–æ–∂–∏—Ç—å new_price —Ä–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ old_qty –ø–ª—é—Å new_qty
```

**–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π**: –°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω—É—é —Ü–µ–Ω—É –≤—Ö–æ–¥–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ä–µ–¥–Ω–µ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö –ª–æ—Ç–æ–≤. –≠—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ PnL –ø—Ä–∏ —á–∞—Å—Ç–∏—á–Ω–æ–º –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–∏.

---

## 6. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∏—Å–∫–∞–º–∏ (—Å—Ç–æ–ø-–ª–æ—Å—Å—ã)

### 6.1. –ü—Ä–æ—Ü–µ—Å—Å –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–æ–ø-–ª–æ—Å—Å–æ–≤

```mermaid
flowchart TD
    A[check_stop_losses] --> B[–ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π]
    B --> C{–ï—Å—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏?}
    C -->|–ù–µ—Ç| D[‚úÖ –ù–µ—Ç –ø–æ–∑–∏—Ü–∏–π –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏]
    C -->|–î–∞| E[–î–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏]
    
    E --> F[–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã]
    F --> G[–†–∞—Å—á–µ—Ç –ª–æ–≥-–¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏: log current_price —Ä–∞–∑–¥–µ–ª–∏—Ç—å entry_price]
    G --> H[–ü–æ—Ä–æ–≥ —Å—Ç–æ–ø-–ª–æ—Å—Å–∞: log 0.95 –ø—Ä–∏–º–µ—Ä–Ω–æ -0.0513]
    
    H --> I{log_return <= threshold?}
    I -->|–î–∞| J[üõë –°—Ç–æ–ø-–ª–æ—Å—Å —Å—Ä–∞–±–æ—Ç–∞–ª]
    I -->|–ù–µ—Ç| K[‚úÖ –ü–æ–∑–∏—Ü–∏—è –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏]
    
    J --> L[–†–∞—Å—á–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø—Ä–æ–¥–∞–∂–∏]
    L --> M[–ü–æ–ª—É—á–µ–Ω–∏–µ sentiment]
    M --> N[–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞: cash + proceeds - commission]
    N --> O[–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ portfolio_state]
    O --> P[–ó–∞–ø–∏—Å—å SELL –≤ trade_history]
    P --> Q[‚úÖ –ü–æ–∑–∏—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞ –ø–æ —Å—Ç–æ–ø-–ª–æ—Å—Å—É]
    
    K --> R{–ï—Å—Ç—å –µ—â–µ –ø–æ–∑–∏—Ü–∏–∏?}
    R -->|–î–∞| E
    R -->|–ù–µ—Ç| S[‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞]
    
    style A fill:#e1f5ff
    style Q fill:#c8e6c9
    style J fill:#ffcccc
```

**–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π**: –°—Ç–æ–ø-–ª–æ—Å—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ —É—Ä–æ–≤–Ω–µ 5% –ø–∞–¥–µ–Ω–∏—è –æ—Ç —Ü–µ–Ω—ã –≤—Ö–æ–¥–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–≥-–¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞). –≠—Ç–æ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –±–æ–ª—å—à–∏—Ö –ø–æ—Ç–µ—Ä—å –ø—Ä–∏ –Ω–µ–±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏ —Ü–µ–Ω—ã. –õ–æ–≥-–¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç–æ–≥–æ –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞, –æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö —Ü–µ–Ω—ã.

### 6.2. –†–∞—Å—á–µ—Ç –ª–æ–≥-–¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏

```mermaid
flowchart LR
    A[entry_price] --> B[–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞]
    B --> C[–†–∞—Å—á–µ—Ç: log current —Ä–∞–∑–¥–µ–ª–∏—Ç—å entry]
    C --> D{log_return –º–µ–Ω—å—à–µ –∏–ª–∏ —Ä–∞–≤–Ω–æ -0.0513?}
    D -->|–î–∞| E[üõë –°—Ç–æ–ø-–ª–æ—Å—Å]
    D -->|–ù–µ—Ç| F[‚úÖ –ü–æ–∑–∏—Ü–∏—è –¥–µ—Ä–∂–∏—Ç—Å—è]
    
    style E fill:#ffcccc
    style F fill:#c8e6c9
```

**–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ª–æ–≥-–¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ (log-returns) —è–≤–ª—è–µ—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–æ–π –≤ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ä–∞—Å—á–µ—Ç–∞—Ö, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∞ –æ–±–ª–∞–¥–∞–µ—Ç —Å–≤–æ–π—Å—Ç–≤–æ–º –∞–¥–¥–∏—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –ª—É—á—à–µ –æ—Ç—Ä–∞–∂–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—É—é –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö —Ü–µ–Ω—ã.

---

## 7. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤

### 7.1. –ü—Ä–æ—Ü–µ—Å—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–æ–≤

```mermaid
flowchart TD
    A[report_generator.py] --> B[–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å–¥–µ–ª–æ–∫ –∏–∑ trade_history]
    B --> C{–ï—Å—Ç—å —Å–¥–µ–ª–∫–∏?}
    C -->|–ù–µ—Ç| D[‚ÑπÔ∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç—á–µ—Ç–∞]
    C -->|–î–∞| E[–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ PnL –ø–æ –∑–∞–∫—Ä—ã—Ç—ã–º —Å–¥–µ–ª–∫–∞–º]
    
    E --> F[–î–ª—è –∫–∞–∂–¥–æ–π SELL —Å–¥–µ–ª–∫–∏]
    F --> G[–ü–æ–∏—Å–∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π BUY —Å–¥–µ–ª–∫–∏]
    G --> H[–†–∞—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã –≤—Ö–æ–¥–∞]
    H --> I[–†–∞—Å—á–µ—Ç gross_pnl –∏ net_pnl]
    I --> J[–†–∞—Å—á–µ—Ç –ª–æ–≥-–¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏]
    
    J --> K[–ê–≥—Ä–µ–≥–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤]
    K --> L[–†–∞—Å—á–µ—Ç Win Rate]
    L --> M[–ê–Ω–∞–ª–∏–∑ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–π —Å GBPUSD=X]
    M --> N[–ê–Ω–∞–ª–∏–∑ –≤–ª–∏—è–Ω–∏—è sentiment –Ω–∞ PnL]
    
    N --> O[–í—ã–≤–æ–¥ –æ—Ç—á–µ—Ç–∞]
    O --> P[PnL –ø–æ –∫–∞–∂–¥–æ–π —Å–¥–µ–ª–∫–µ]
    O --> Q[–û–±—â–∏–π Win Rate]
    O --> R[–ö–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ —Å –≤–∞–ª—é—Ç–Ω—ã–º–∏ –ø–∞—Ä–∞–º–∏]
    O --> S[–í–ª–∏—è–Ω–∏–µ sentiment –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã]
    
    style A fill:#e1f5ff
    style O fill:#c8e6c9
    style E fill:#fff9c4
```

**–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π**: –û—Ç—á–µ—Ç—ã –ø–æ–∑–≤–æ–ª—è—é—Ç –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ç–æ—Ä–≥–æ–≤–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏. Win Rate –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∏–±—ã–ª—å–Ω—ã—Ö —Å–¥–µ–ª–æ–∫, –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ –ø–æ–º–æ–≥–∞—é—Ç –ø–æ–Ω—è—Ç—å –≤–ª–∏—è–Ω–∏–µ –≤–∞–ª—é—Ç–Ω—ã—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤, –∞ –∞–Ω–∞–ª–∏–∑ sentiment –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ —Ö–æ—Ä–æ—à–æ sentiment –∞–Ω–∞–ª–∏–∑ –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–¥–µ–ª–æ–∫.

### 7.2. –†–∞—Å—á–µ—Ç PnL –ø–æ –∑–∞–∫—Ä—ã—Ç—ã–º —Å–¥–µ–ª–∫–∞–º

```mermaid
sequenceDiagram
    participant RG as report_generator
    participant DB as PostgreSQL
    participant Calc as –†–∞—Å—á–µ—Ç PnL
    
    RG->>DB: SELECT * FROM trade_history ORDER BY ts
    DB-->>RG: –í—Å–µ —Å–¥–µ–ª–∫–∏
    
    RG->>Calc: –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π –ø–æ —Ç–∏–∫–µ—Ä–∞–º
    Note over Calc: –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–∫–µ—Ä–∞: –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ quantity –∏ cost_basis
    
    RG->>Calc: –û–±—Ä–∞–±–æ—Ç–∫–∞ BUY —Å–¥–µ–ª–æ–∫
    Note over Calc: position_qty += qty<br/>position_cost += qty √ó price + commission
    
    RG->>Calc: –û–±—Ä–∞–±–æ—Ç–∫–∞ SELL —Å–¥–µ–ª–æ–∫
    Note over Calc: avg_entry = position_cost / position_qty<br/>gross_pnl = qty √ó (price - avg_entry)<br/>net_pnl = proceeds - cost_for_sold<br/>log_return = log(price / avg_entry)
    
    Calc-->>RG: –°–ø–∏—Å–æ–∫ TradePnL –æ–±—ä–µ–∫—Ç–æ–≤
    RG->>RG: –†–∞—Å—á–µ—Ç Win Rate –∏ –º–µ—Ç—Ä–∏–∫
```

**–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π**: –†–∞—Å—á–µ—Ç PnL –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –º–æ–¥–µ–ª—å —Å—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω–æ–π —Ü–µ–Ω—ã –≤—Ö–æ–¥–∞ (FIFO-–ø–æ–¥–æ–±–Ω—ã–π –ø–æ–¥—Ö–æ–¥). –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—Ç—å –ø—Ä–∏–±—ã–ª—å/—É–±—ã—Ç–æ–∫ –¥–∞–∂–µ –ø—Ä–∏ —á–∞—Å—Ç–∏—á–Ω–æ–º –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–π.

---

## 8. –í–µ–∫—Ç–æ—Ä–Ω–∞—è –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π

### 8.1. –ü—Ä–æ—Ü–µ—Å—Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –ë–ó (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)

```mermaid
flowchart TD
    A[–ù–æ–≤–æ—Å—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ knowledge_base] --> B[–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è]
    B --> C[–ì–µ–Ω–µ—Ä–∞—Ü–∏—è embedding —á–µ—Ä–µ–∑ OpenAI API]
    C --> D[–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ trade_kb —Å embedding]
    
    E[AnalystAgent.get_decision] --> F[–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞]
    F --> G[–ì–µ–Ω–µ—Ä–∞—Ü–∏—è embedding –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞]
    G --> H[–í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ –≤ trade_kb]
    
    H --> I[–ü–æ–∏—Å–∫ —Ç–æ–ø-5 –ø–æ—Ö–æ–∂–∏—Ö —Å–æ–±—ã—Ç–∏–π]
    I --> J[–ê–Ω–∞–ª–∏–∑ –∏—Å—Ö–æ–¥–æ–≤ –ø–æ—Ö–æ–∂–∏—Ö —Å–æ–±—ã—Ç–∏–π]
    J --> K[–£–ª—É—á—à–µ–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è]
    
    style A fill:#e1f5ff
    style K fill:#c8e6c9
    style C fill:#fff9c4
```

**–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π**: –í–µ–∫—Ç–æ—Ä–Ω–∞—è –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π (`trade_kb`) –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ—Ö–æ–∂–∏—Ö –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π. –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç —É–ª—É—á—à–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ —Ä–µ—à–µ–Ω–∏–π —á–µ—Ä–µ–∑ –∞–Ω–∞–ª–∏–∑ —Ç–æ–≥–æ, –∫–∞–∫ —Ä—ã–Ω–æ–∫ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–ª –Ω–∞ –ø–æ—Ö–æ–∂–∏–µ —Å–∏—Ç—É–∞—Ü–∏–∏ –≤ –ø—Ä–æ—à–ª–æ–º. **–°—Ç–∞—Ç—É—Å**: –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è, —Å–º. [VECTOR_KB_IMPLEMENTATION.md](docs/VECTOR_KB_IMPLEMENTATION.md)

### 8.2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –≤ –∞–Ω–∞–ª–∏–∑

```mermaid
sequenceDiagram
    participant AA as AnalystAgent
    participant VKB as VectorKB
    participant OpenAI as OpenAI API
    participant DB as PostgreSQL (trade_kb)
    
    AA->>AA: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Ç–µ–∫—É—â–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏
    Note over AA: "MSFT: close=350, sentiment=0.7, –Ω–æ–≤–æ—Å—Ç—å –æ –ø—Ä–æ–¥—É–∫—Ç–µ"
    
    AA->>VKB: search_similar(query, ticker="MSFT", limit=5)
    VKB->>OpenAI: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è embedding –¥–ª—è query
    OpenAI-->>VKB: embedding[1536]
    
    VKB->>DB: –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ pgvector
    Note over DB: SELECT * FROM trade_kb<br/>WHERE embedding <=> :query_embedding<br/>ORDER BY similarity LIMIT 5
    
    DB-->>VKB: –¢–æ–ø-5 –ø–æ—Ö–æ–∂–∏—Ö —Å–æ–±—ã—Ç–∏–π
    VKB->>VKB: –ê–Ω–∞–ª–∏–∑ –∏—Å—Ö–æ–¥–æ–≤ —Å–æ–±—ã—Ç–∏–π
    Note over VKB: –ü—Ä–æ–≤–µ—Ä–∫–∞, –∫–∞–∫ —Ä—ã–Ω–æ–∫ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–ª<br/>–Ω–∞ –ø–æ—Ö–æ–∂–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ –≤ –ø—Ä–æ—à–ª–æ–º
    
    VKB-->>AA: –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
    AA->>AA: –£–ª—É—á—à–µ–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è —Å —É—á–µ—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
```

**–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π**: –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å –ø–æ—Ö–æ–∂–∏–µ —Å–æ–±—ã—Ç–∏—è –ø–æ —Å–º—ã—Å–ª—É, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º. –≠—Ç–æ –æ—Å–æ–±–µ–Ω–Ω–æ –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–∏—Ç—É–∞—Ü–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ—Ö–æ–∂–∏ –ø–æ —Å—É—Ç–∏, –Ω–æ –≤—ã—Ä–∞–∂–µ–Ω—ã —Ä–∞–∑–Ω—ã–º–∏ —Å–ª–æ–≤–∞–º–∏. **–°—Ç–∞—Ç—É—Å**: –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è.

---

## 9. –î–∏–∞–≥—Ä–∞–º–º—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

### 9.1. –û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

```mermaid
graph TB
    subgraph "–í–Ω–µ—à–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö"
        A[yfinance API]
        B[–ù–æ–≤–æ—Å—Ç–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏]
        C[OpenAI API - –±—É–¥—É—â–µ–µ]
    end
    
    subgraph "–¢–æ—Ä–≥–æ–≤—ã–µ –∞–≥–µ–Ω—Ç—ã"
        D[AnalystAgent]
        E[ExecutionAgent]
    end
    
    subgraph "–£—Ç–∏–ª–∏—Ç—ã"
        F[update_prices.py]
        G[news_importer.py]
        H[report_generator.py]
    end
    
    subgraph "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö PostgreSQL"
        I[quotes]
        J[knowledge_base]
        K[trade_kb - –≤–µ–∫—Ç–æ—Ä–Ω–∞—è –ë–ó]
        L[portfolio_state]
        M[trade_history]
    end
    
    A --> F
    F --> I
    B --> G
    G --> J
    J -.->|–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è| K
    C -.->|–ì–µ–Ω–µ—Ä–∞—Ü–∏—è embeddings| K
    
    I --> D
    J --> D
    K -.->|–í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫| D
    
    D --> E
    E --> L
    E --> M
    
    M --> H
    I --> H
    L --> H
    
    style D fill:#e1f5ff
    style E fill:#e1f5ff
    style K fill:#fff9c4
    style I fill:#c8e6c9
    style J fill:#c8e6c9
    style L fill:#c8e6c9
    style M fill:#c8e6c9
```

**–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π**: –°–∏—Å—Ç–µ–º–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ –º–æ–¥—É–ª—å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ. –ö–∞–∂–¥—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –∏–º–µ–µ—Ç —á–µ—Ç–∫—É—é –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å: AnalystAgent –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç, ExecutionAgent –∏—Å–ø–æ–ª–Ω—è–µ—Ç, —É—Ç–∏–ª–∏—Ç—ã –æ–±–Ω–æ–≤–ª—è—é—Ç –¥–∞–Ω–Ω—ã–µ –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç –æ—Ç—á–µ—Ç—ã. –í–µ–∫—Ç–æ—Ä–Ω–∞—è –ë–ó –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è –≤ –ø—Ä–æ—Ü–µ—Å—Å –∞–Ω–∞–ª–∏–∑–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ —Ä–µ—à–µ–Ω–∏–π.

### 9.2. –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö: –æ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–µ–Ω –¥–æ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è —Å–¥–µ–ª–∫–∏

```mermaid
sequenceDiagram
    participant Cron as Cron/Scheduler
    participant Update as update_prices.py
    participant YF as yfinance
    participant DB as PostgreSQL
    participant Analyst as AnalystAgent
    participant Exec as ExecutionAgent
    participant Portfolio as portfolio_state
    
    Cron->>Update: –ï–∂–µ–¥–Ω–µ–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    Update->>YF: –ó–∞–ø—Ä–æ—Å –∫–æ—Ç–∏—Ä–æ–≤–æ–∫
    YF-->>Update: –î–∞–Ω–Ω—ã–µ
    Update->>DB: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ quotes
    
    Note over Analyst,Exec: –ó–∞–ø—É—Å–∫ —Ç–æ—Ä–≥–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞
    Exec->>Analyst: get_decision(ticker)
    Analyst->>DB: –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ—Ç–∏—Ä–æ–≤–æ–∫ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –¥–Ω–µ–π)
    Analyst->>DB: –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π (knowledge_base)
    Analyst->>Analyst: –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑
    Analyst->>Analyst: Sentiment –∞–Ω–∞–ª–∏–∑
    Analyst-->>Exec: –†–µ—à–µ–Ω–∏–µ (BUY/STRONG_BUY/HOLD)
    
    alt –†–µ—à–µ–Ω–∏–µ = BUY/STRONG_BUY
        Exec->>DB: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π
        Exec->>DB: –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã
        Exec->>Exec: –†–∞—Å—á–µ—Ç —Ä–∞–∑–º–µ—Ä–∞ –ø–æ–∑–∏—Ü–∏–∏
        Exec->>Portfolio: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ portfolio_state
        Exec->>DB: –ó–∞–ø–∏—Å—å –≤ trade_history
    else –†–µ—à–µ–Ω–∏–µ = HOLD
        Exec->>Exec: –ü—Ä–æ–ø—É—Å–∫ –ø–æ–∫—É–ø–∫–∏
    end
    
    Exec->>Exec: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ø-–ª–æ—Å—Å–æ–≤
    Exec->>DB: –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–π –ø—Ä–∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–∏ —Å—Ç–æ–ø-–ª–æ—Å—Å–∞
```

**–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π**: –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –æ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–æ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è —Å–¥–µ–ª–æ–∫. –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–Ω–æ–º–Ω–æ –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ cron –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–µ–Ω. –¢–æ—Ä–≥–æ–≤—ã–π —Ü–∏–∫–ª –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

### 9.3. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Ä—Ç—Ñ–µ–ª–µ–º –∏ —Ä–∏—Å–∫–∞–º–∏

```mermaid
flowchart TD
    A[–ü–æ—Ä—Ç—Ñ–µ–ª—å: portfolio_state] --> B[–†–∞—Å—á–µ—Ç —Ç–µ–∫—É—â–µ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏]
    B --> C[–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏–≤–µ—Ä—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏]
    C --> D{–î–æ–ª—è –∞–∫—Ç–∏–≤–∞ > 20%?}
    
    D -->|–î–∞| E[–†–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞: —á–∞—Å—Ç–∏—á–Ω–∞—è –ø—Ä–æ–¥–∞–∂–∞]
    D -->|–ù–µ—Ç| F[–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ø-–ª–æ—Å—Å–æ–≤]
    
    E --> G[–§–∏–∫—Å–∞—Ü–∏—è –ø—Ä–∏–±—ã–ª–∏]
    G --> H[–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ portfolio_state]
    H --> F
    
    F --> I[–î–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏]
    I --> J{log_return <= -5%?}
    J -->|–î–∞| K[–ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–∏]
    J -->|–ù–µ—Ç| L[–ü–æ–∑–∏—Ü–∏—è –¥–µ—Ä–∂–∏—Ç—Å—è]
    
    K --> M[–ó–∞–ø–∏—Å—å –≤ trade_history]
    L --> N[–°–ª–µ–¥—É—é—â–∞—è –ø–æ–∑–∏—Ü–∏—è]
    M --> N
    
    N --> O{–ï—Å—Ç—å –µ—â–µ –ø–æ–∑–∏—Ü–∏–∏?}
    O -->|–î–∞| I
    O -->|–ù–µ—Ç| P[‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∏—Å–∫–∞–º–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–æ]
    
    style A fill:#e1f5ff
    style P fill:#c8e6c9
    style E fill:#fff9c4
    style K fill:#ffcccc
```

**–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π**: –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∏—Å–∫–∞–º–∏ –≤–∫–ª—é—á–∞–µ—Ç –¥–≤–∞ —É—Ä–æ–≤–Ω—è –∑–∞—â–∏—Ç—ã: —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫—É –ø–æ—Ä—Ç—Ñ–µ–ª—è (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ–ª–∏ –æ–¥–Ω–æ–≥–æ –∞–∫—Ç–∏–≤–∞) –∏ —Å—Ç–æ–ø-–ª–æ—Å—Å—ã (–∑–∞—â–∏—Ç–∞ –æ—Ç –±–æ–ª—å—à–∏—Ö –ø–æ—Ç–µ—Ä—å). –†–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞, –Ω–æ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞ –≤ ROADMAP.

---

## –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏–∞–≥—Ä–∞–º–º

1. **Mermaid –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤:**
   - ‚úÖ GitHub/GitLab (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è)
   - ‚úÖ VS Code (—Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º Mermaid Preview)
   - ‚úÖ –û–Ω–ª–∞–π–Ω-—Ä–µ–¥–∞–∫—Ç–æ—Ä—ã: [mermaid.live](https://mermaid.live)

2. **–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - –î–∏–∞–≥—Ä–∞–º–º—ã –º–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä—è–º–æ –≤ Markdown
   - –î–ª—è —Å–ª–æ–∂–Ω—ã—Ö –¥–∏–∞–≥—Ä–∞–º–º –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ [mermaid.live](https://mermaid.live) –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏

### –°–≤—è–∑—å —Å –∫–æ–¥–æ–º

–≠—Ç–∏ –¥–∏–∞–≥—Ä–∞–º–º—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç:
- `analyst_agent.py` - –∞–Ω–∞–ª–∏–∑ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤
- `execution_agent.py` - –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–¥–µ–ª–æ–∫
- `init_db.py` - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î
- `update_prices.py` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω
- `news_importer.py` - –∏–º–ø–æ—Ä—Ç –Ω–æ–≤–æ—Å—Ç–µ–π
- `report_generator.py` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤
- `vector_kb.py` - –≤–µ–∫—Ç–æ—Ä–Ω–∞—è –ë–ó (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∏–∞–≥—Ä–∞–º–º

–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –¥–∏–∞–≥—Ä–∞–º–º—ã –≤ —ç—Ç–æ–º —Ñ–∞–π–ª–µ. –î–∏–∞–≥—Ä–∞–º–º—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å –∫–æ–¥–æ–º.

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: 2026-02-14  
**–í–µ—Ä—Å–∏—è —Å–∏—Å—Ç–µ–º—ã**: 1.1.0

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –≤–µ—Ä—Å–∏–∏ 1.1.0:
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω Strategy Manager –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—ã–±–æ—Ä–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —à–∫–∞–ª–∞ sentiment (-1.0 –¥–æ 1.0)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ insight –∏–∑ –Ω–æ–≤–æ—Å—Ç–µ–π
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è strategy_name –≤ trade_history
- ‚úÖ –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π

